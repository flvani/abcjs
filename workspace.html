<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" lang="en">
    <head>
    <link href="workspace.css" rel="stylesheet"></link>
            <!-- 
          MAIN DATA STRUCTURES
        
            Tune
              midi {}
              lines[]
                staffs[]
                   voices[]

            Printer
              layouter  Layout {}
              staffgroups[] Staffgroup {}

            Layout 
              Staffgroup {}
                 voices[]
                   beams[]
                   children[]
                   otherchildren[]
                   stave {}

            stave {}
               y
               top
               bottom
               highest
               lowest
        
           DONE:
             Verificar o transporte de keys com modos min e maj
             Verificar os limites máximo e mínimos para transporte de keys
             Ignorar Accents na transposição
             Tablatura: gerar mesmo sem o baixo
             Layout:    Revisar a impressão dos elementos ending, accents e lyrics
             Layout:    Revisar a de linhas de texto, quando há mais de uma linha
             Tablatura: imprimir os de pausas adequadamente no baixo
             Tablatura: parse
                tratar numeros hexa
                tratar a adicao de pausas - continuacao
                tratar acordes
                tratar startChar e endChar
                registar o parse da tablatura
                gerar a linha durante a inferencia
                imprimir baseado na linha existente
                melhorar a relação open/close do fole na melodia
                revisar a impressão de múltiplas notas na mesma coluna
        
           TODO:
             Tablatura: 
                tratar adequadamente os acordes (de baixo)      
                promover a inversão do fole se a posição do botao for melhor
        
        -->
	<title>Draw The Dots: Tune Editor</title>
        <meta http-equiv="content-type" content="text/html; charset=UTF-8"></meta>
    </head>
    <body>

        <script type="text/javascript" src="MIDI.js/MIDI_2.03-min.js"></script>
        
	<script type="text/javascript" src="proto_noconflict.js" ></script>
	<script type="text/javascript" src="jquery-1.11.1.min.js" ></script>
	<script type="text/javascript" src="filemanager.js" ></script>

        <script type="text/javascript" src="data/abc_tune.js" ></script>
	<script type="text/javascript" src="api/abc_tunebook.js" ></script>
        
        <script type="text/javascript" src="midi/midiparser.js" ></script>
        <script type="text/javascript" src="midi/midiplayer.js" ></script>

        <script type="text/javascript" src="write/raphael.js" ></script>
	<script type="text/javascript" src="write/sprintf.js" ></script>
        <script type="text/javascript" src="write/abc_glyphs.js" ></script>
        <script type="text/javascript" src="write/abc_graphelements.js" ></script>
        <script type="text/javascript" src="write/abc_layout.js" ></script>
        <script type="text/javascript" src="write/abc_write.js" ></script>

        <script type="text/javascript" src="parse/abc_parse_header.js" ></script>
	<script type="text/javascript" src="parse/abc_tokenizer.js" ></script>
	<script type="text/javascript" src="parse/abc_parse_key_voice.js" ></script>
	<script type="text/javascript" src="parse/abc_parse_directive.js" ></script>
        <script type="text/javascript" src="parse/abc_parse.js" ></script>
        <script type="text/javascript" src="parse/abc_transposer.js" ></script>
	<script type="text/javascript" src="parse/abc_common.js" ></script>

        <!-- diatonic accordion map -->
        <script type="text/javascript" src="diatonic/diatonic-map.js"></script>
        
        <!-- support for diatonic accordion tablature -->
        <script type="text/javascript" src="tablature/accordion_map.js"></script>
        <script type="text/javascript" src="tablature/accordion_infer.js"></script>
        <script type="text/javascript" src="tablature/accordion_parse.js"></script>
        <script type="text/javascript" src="tablature/accordion_layout.js"></script>
        
 	<script type="text/javascript" src="edit/abc_editor.js" ></script>

<div id="editor" style="display:inline-block;"> 
<div id="editControl" style="display:inline-block;"> 

<textarea id="abc" cols="120" rows="10" >
X:1
L:1/4
Q:120
T:Teste endings
M:2/4
K:G
V:1 treble stem=up
[V:1]|: d |1 f | f |2 a | a |
[V:1]| d :| f |  a |]
[V:1]| d |1 f :|:2 f | a | a |
[V:1]| d :| f |  a |]
</textarea>
    
<textarea id="abcx" cols="120" rows="10" style="display: none;" >
X:1
%%papersize A4
%%barnumbers 0
T:Rincão Base
L:1/16
Q:60
M:2/4
K:G
V:1 treble stem=up
V:2 treble stem=down
V:3 bass
[V:1]| d8-d8 |
%[V:2]| a f a f a f a f a f a f a f a f |
[V:2]| a4 f4 a4 f4 |

X:2
%%barnumbers 1
%restsintab
%%papersize legal
T:Vanera Grossa teste
M:2/4
L:1/4
Q:80
K:G
V:1 treble stem=down
%[V:1]| z ([CE] C) z C-E z C-[CE] z [CE]-[CE] z  C-[CEG] z  (CE) z (C [CE]) z ([CE] [CE]) z (FD [DF]) z (F(D D)F) z (C (E) G) z (C (C) C) z (([CE] C) E) z (C(E [CE])) |
[V:1] (C (C) C)
V:3 accordionTab

X:3
%%papersize A4
%%barnumbers 0
%%score(1 2) 3 4    
T:Rincão Base
L:1/16
Q:76
M:2/4
K:G
V:1 treble stem=up
V:2 treble stem=down
V:3 bass
[V:1]| x8 | d8- | d8 | d8- | d8 | d8- | d8 |
[V:2]|[DB]2[Ec]2[DB]2d2 |[A,]2C2 A,A,CC | [D]2CC  B,B,A,A, |[G,]2D2 B,B,DD | [E]ED2 C2B,B, |[A,]2C2 A,A,CC |[D]2C2B,2A,2  | 
[V:3]| G,,3[G,B,D] G,,2[G,B,D]2 | D,,3[D,F,A,] D,,2[D,F,A,]2 | D,,3[D,F,A,] D,,2[D,F,A,]2 | G,,3[G,B,D] G,,2[G,B,D]2 | G,,3[G,B,D] G,,2[G,B,D]2 | D,,3[D,F,A,] D,,2[D,F,A,]2 | D,,3[D,F,A,] D,,2[D,F,A,]2 |

X:1003
%%papersize A4
%%barnumbers 1
%restsintab
T:Mercedita
Q: 108
L:1/8
M:3/4
K:C treble
P:Parte I
V:Melodia treble
|:[DF]- [DF][EG] | [D2F2] [EG][FA]- [FA][DF] |
V:Baixo bass
|:[F,A,C] D, z | G,, [G,B,d,] G,, [G,B,d,] G,, z | 
V:Tab accordionTab

X:4
%%barnumbers 1
%%score( 1 2) 3 4
%%restsintab
%%papersize legal
T:Vanera Grossa teste
M:2/4
L:1/16
Q:80
K:G
V:1 treble stem=down
[V:1]| (CD)2(FD [DF]2)[CE]2 |

X:5
%%papersize A4
%%barnumbers 0
%%score(1 2) (3 4) 5
%%restsintab
T:Rincão Base - baixos duplos
L:1/16
Q:78
M:2/4
K:G
V:1 treble stem=down
V:2 treble
V:3 bass
V:4 bass
[V:1]|[DB]2[Ec]2[DB]2d2 |A,2C2 A,A,CC | D2CC  B,B,A,A, |
[V:2]| x8  | (d8|d8) |
[V:3]| G,,3[G,B,D] G,,2[G,B,D]2 | D,,3[D,F,A,] D,,2[D,F,A,]2 | D,,3[D,F,A,] D,,2[D,F,A,]2 |
[V:4]| x3 G,, x2 G,,2 | x8 |x8 |
V:5 accordionTab
%| G+[57]2 >+[4'6'] Gg+[>>] G+[57]2 Gg+82 |

</textarea>
   </div>
    <br>
    <div id="outrosControles" style="display:inline-block; color: #FFFFFF; background-color: #000; padding: 2px;">
        <select id="selGaitas" ></select>
        <select id="selKey" ></select>
        <input type="submit" id="maisOitava" value="+ Oitava" onclick="javascript:doTranspose(12);" />
        <input type="submit" id="menosOitava" value="- Oitava" onclick="javascript:doTranspose(-12);" />
        <input type="button" id="printBtn" value="Print Preview" />
        <input type="submit" id="forceRefresh" value="Refresh" onclick="javascript:doForceRefresh();" />
        <input type="checkbox" id="chkAutoRefresh" />Auto refresh 
        <input type="checkbox" id="chkDebug" onclick="javascript:doCheckDebug();" />Debug
        <input type="button" id="playBtn" value="Play" />
        <input type="button" id="pauseBtn" value="Pause" />
        <input type="button" id="stopBtn" value="Stop" />
        <label id="currentPlayTime" style="font-weight: bold; color: yellow; padding-left: 5px; padding-right: 3px;">00:00.00</label>
    </div>
    <div id="warnings"></div>
    <hr>    
    </div> <!-- editor -->
    <div id="canvas" style="overflow-y: scroll; float:left;"> </div>
        
        <script type="text/javascript">
            window.myEditor = {};
            window.accordionMaps = [];
            
            window.printButton = document.getElementById("printBtn");
            
            window.playButton = document.getElementById("playBtn");
            window.pauseButton = document.getElementById("pauseBtn");
            window.stopButton = document.getElementById("stopBtn");
            
            window.addEventListener('load', initApp, false);

            function loadAccordions( files, cb )  {
                var toLoad = 0;
                for( var f = 0; f < files.length; f ++ ) {
                    toLoad ++;
                    $.getJSON( files[f], {  format: "json"  })
                        .done(function( data ) {
                            window.accordionMaps.push( new DIATONIC.map.Accordion(data) );
                        })
                        .fail(function( data, textStatus, error ) {
                            var err = textStatus + ", " + error;
                            console.log( "Accordion Load Failed:\nLoading: " + data.responseText.substr(1,40) + '...\nError:\n ' + err );
                        })
                        .always(function() {
                            toLoad --;
                            if( toLoad === 0 && cb ) cb();
                        });
                }
            };
            
            function initApp() {
                MIDI.loader = new widgets.Loader();
                
                MIDI.loadPlugin({
                    soundfontUrl: "./soundfont/"
                   ,instruments: "accordion"
                   ,callback: function() {initApp0();}
                });
            }
            
            function initApp0() {
                MIDI.loader.stop();
                MIDI.programChange(0, 21); // canais para accordeon
                MIDI.programChange(1, 21); // 
                MIDI.programChange(2, 21); // 
                MIDI.programChange(3, 21); // 
                MIDI.programChange(4, 21); // 
                MIDI.programChange(5, 21); // 
                
                loadAccordions(
                    [
                       'accordions/hohner.gc.accordion'
                      ,'accordions/hohner.cf.club.br.accordion'
                    ]
                    ,initApp1 // call back after loading
                );
            }
            
            function initApp1() {

                debug = false;
                
                player = new ABCXJS.midi.Player();
                
                cpt = document.getElementById("currentPlayTime");
                
                playerCallBack = function ( playListPos, playTime, currMeasure ) {
                  var t = playTime.cTime;
                  cpt.innerHTML = t;
                };
                
                playerCallBackOnEnd = function ( ) {
                    cpt.innerHTML = "00:00.00";
                    myEditor.printer.clearSelection();
                    var warns = player.getWarnings();
                    if( warns ) {
                        var txt = "";
                        warns.forEach(function(msg){ txt += msg + '<br>'; });
                        document.getElementById("warnings").innerHTML = '<hr>'+txt;
                    }
                };
                
                player.setCallbackOnEnd(playerCallBackOnEnd);
 
                myEditor = new ABCXJS.Editor(
                        "abc", {
                             canvas_id: "canvas"
                            ,refreshController_id: "chkAutoRefresh"
                            ,accordionSelector_id: "selGaitas"
                            ,accordionMaps: window.accordionMaps
                            ,keySelector_id: "selKey"
                            ,generate_warnings: true
                            ,warnings_id: "warnings"
                            ,generate_midi: true
                            ,midi_options: {program: 21, qpm: 150, type: "qt"}
                            ,render_options: {}
                            ,gui: false
                        });

                printButton.addEventListener("click", function() {
                    document.getElementById("editor").style.display = "none";
                    window.print();
                    document.getElementById("editor").style.display = "inline-block";
                }, false);
                
                playButton.addEventListener("click", function() {
                    player.startPlay(myEditor.tunes[0].midi, playerCallBack );
                    //player.startDidacticPlay(myEditor.tunes[0].midi, 'note');
                }, false);
                pauseButton.addEventListener("click", function() {
                    player.pausePlay();
                }, false);
                stopButton.addEventListener("click", function() {
                    var warns = player.stopPlay();
                }, false);
                
            }

            function doTranspose(value) {
                myEditor.fireChanged(value, "force");
            };

            function doForceRefresh() {
                myEditor.fireChanged(0, "force");
            };

            function doCheckDebug() {
                debug = document.getElementById("chkDebug").checked;
                myEditor.fireChanged(0, "force");
            };


        </script>

    </body>
</html>
