<html xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" lang="en">
    <head>
	<title>Draw The Dots: Tune Editor</title>
        <meta name="viewport" content="width=device-width, initial-scale=0.8, minimum-scale=0.8, maximum-scale=2.0" />
        <meta http-equiv="content-type" content="text/html; charset=UTF-8"></meta>
        <link rel="icon" type="image/icon" href="images/favicon.ico" />
        <link href="css/workspace.css" rel="stylesheet"></link>
    
            <!-- 
          MAIN DATA STRUCTURES
        
            Tune
              midi {}
              lines[]
                staffs[]
                   voices[]

            Printer
              layouter  Layout {}
              staffgroups[] Staffgroup {}

            Layout 
              Staffgroup {}
                 voices[]
                   beams[]
                   children[]
                   otherchildren[]
                   stave {}

            stave {}
               y
               top
               bottom
               highest
               lowest
        
           DONE:
             Verificar o transporte de keys com modos min e maj
             Verificar os limites máximo e mínimos para transporte de keys
             Ignorar Accents na transposição
             Verificar o espaçamento para os jump markers
             barsperstaff: ao dividir a linha decidir onde fica jumpinfo e barnumbers
             Verificar durante o parse e incluir o barnumber na barra correta
             Tablatura: gerar mesmo sem o baixo
             Layout:    Revisar a impressão dos elementos ending, accents e lyrics
             Layout:    Revisar a de linhas de texto, quando há mais de uma linha
             Layout:    Imprimir ao final da staff alguns jump markers
             Tablatura: imprimir os de pausas adequadamente no baixo
             Tablatura: parse
                tratar numeros hexa
                tratar a adicao de pausas - continuacao
                tratar acordes
                tratar startChar e endChar
                registar o parse da tablatura
                gerar a linha durante a inferencia
                imprimir baseado na linha existente
                melhorar a relação open/close do fole na melodia
                revisar a impressão de múltiplas notas na mesma coluna
                Verificar durante o parse e incluir o barnumber na barra correta
             MIDI PARSER
                Bug: falta informação de barra de compasso para didatic play measure e goto-measure
                Bug: manter a informação de passadas quando existe um salto originado em compassos que estão debaixo da casa 1 (ending)
        
           TODO:
             EDITOR: 
                Bug: transposição de acordes de baixo
                Melhorar a transposição dos baixos, mantendo na oitava correta
             Tablatura: 
                tratar adequadamente os acordes (de baixo)      
                promover a inversão do fole se a posição do botao for melhor
        
        -->
    </head>
    <body class="mapa">

	<script type="text/javascript" src="proto_noconflict.js" ></script>

        <!-- suporte a MIDI -->
        <script type="text/javascript" src="MIDI.js/MIDI_3.00-min.js"></script>

        
        <script type="text/javascript" src="jquery/jquery-1.11.1.min.js" ></script>
	        
        <script type="text/javascript" src="svg/svg.js" ></script>
        <script type="text/javascript" src="svg/glyphs.js" ></script>
        
        <script type="text/javascript" src="file/filemanager.js" ></script>

        <script type="text/javascript" src="api/abc_tunebook.js" ></script>
        
        <script type="text/javascript" src="data/abc_tune.js" ></script>
        
	<script type="text/javascript" src="parse/abc_common.js" ></script>
        <script type="text/javascript" src="parse/abc_parse_header.js" ></script>
	<script type="text/javascript" src="parse/abc_tokenizer.js" ></script>
	<script type="text/javascript" src="parse/abc_parse_key_voice.js" ></script>
	<script type="text/javascript" src="parse/abc_parse_directive.js" ></script>
        <script type="text/javascript" src="parse/abc_parse.js" ></script>
        <script type="text/javascript" src="parse/abc_transposer.js" ></script>

        <script type="text/javascript" src="midi/midi_common.js" ></script>
        <script type="text/javascript" src="midi/midi_parser.js" ></script>
        <script type="text/javascript" src="midi/midi_player.js" ></script>

        <script type="text/javascript" src="write/sprintf.js" ></script>
        <script type="text/javascript" src="write/abc_glyphs.js" ></script>
        <script type="text/javascript" src="write/abc_graphelements.js" ></script>
        <script type="text/javascript" src="write/abc_layout.js" ></script>
        <script type="text/javascript" src="write/abc_write.js" ></script>

        <!-- diatonic accordion map -->
        <script type="text/javascript" src="diatonic/diatonic_common.js"></script>
        <script type="text/javascript" src="diatonic/diatonic_accordion_map.js"></script>
        <script type="text/javascript" src="diatonic/diatonic_keyboard.js"></script>
        <script type="text/javascript" src="diatonic/diatonic_button.js"></script>
        
        <!-- support for diatonic accordion tablature -->
        <script type="text/javascript" src="tablature/tablature_accordion.js"></script>
        <script type="text/javascript" src="tablature/tablature_accordion_infer.js"></script>
        <script type="text/javascript" src="tablature/tablature_accordion_parse.js"></script>
        <script type="text/javascript" src="tablature/tablature_accordion_layout.js"></script>
        
 	<script type="text/javascript" src="edit/abc_editor.js" ></script>
        
        <!--                     menor
            C,,   C,  E,  G,     C,  ^D,  G,
            D,,   D, ^F,  A,     D,   F,  A,
            E,,   E, ^G,  B,     E,   G,  B,
            F,,   F,  A,  C      F,  ^G,  C
            G,,   G,  B,  D      G,  ^A,  D
            A,,   A, ^C   E      A,   C   E
            B,,   B, ^D  ^F      B,   D  ^F
            Bb,,  Bb, D   F      Bb, ^C   F
        -->    
    

    
<div id="editorDiv" style="position: fixed; top:0; display:inline-block; background-color: gray; width:100%; z-index: 100;"> 
<div id="editControl" style="display:inline-block;"> 

<textarea id="svg_source" class="abc_textarea" spellcheck="false" cols="120" rows="10" style="display: none;" >
</textarea>
    
<textarea class="abc_textarea" spellcheck="false" id="abc" cols="120" rows="10"  style="display: inline;">
%%barnumbers 0
%%papersize A4
%%score (0 1) 2 3
T:Danúbio Azul
C:J. Strauss
C:(arr. Mario Mascarenhas)
Z:Flávio Vani
N:Mapa para Acordeons Diatônicos powered by ABCXJS.
M:3/4
L:1/4
Q:160
K:C
V:0 treble  
| C E G |  G3-  | G3- | G z  C | C E G |  G3  | G3- | G z B, |
| B, D B | B3- | B3- | B z  B, | B, D B | B3- | B3- | B z C | C E G | 
| c3- | c3- | c z C | C E G | c3- | c3- |
| c z D | D F B | B3- | B ^F G | [ce]3- | [ce] c E |
| E2 D | A2 G | C z/2 [EGc]/2 [EGc] !fine! || [K:G] z c B | B A A |
| z A ^G | ^G A A | z D D | E2 D | z D D | A2 G |
| z c B | B A A | z A B | d c c | z f a | a2 g |
| f3/2 e/2 c/2 A/2 | e/2e/2 e d | g z z | [Bdg]3 | [ceg]3 | [Bfg] z z !dcalfine! |]
V:1 treble stem=up 
[K:C] | x3 | x  x g | g x e | e  x2 | x3 | x  x g | g x f | f  x2 |
| x3 | x2 a | a x f | f x2 | x3 | x2 a | a x e |e x2 | x3 |
| x2 c' | c' x g | g x2 | x3 | x2 c' | c' x a |
| a x2 | x3 | x3 | x3 | x3 | x3 |
| x3 | x3 | x3 || [K:G] x3 | x3 |
| x3 | x3 | x3 | x3 | x3 | x3 |
| x3 | x3 | x3 | x3 | x3 | x3 |
| x3 | x3 | x3 | x3 | x3 | x3 |]
V:2 bass
[K:C] |z3 | C,, [C,E,G,] [C,E,G,] | C,, [C,E,G,] [C,E,G,] | C,, [C,E,G,] [C,E,G,] | C,, [C,E,G,] [C,E,G,] | C,, [C,E,G,] [C,E,G,] | G,, [G,B,D] [G,B,D] | G,, [G,B,D] [G,B,D] |
| G,, [G,B,D] [G,B,D] | G,, [G,B,D] [G,B,D] | G,, [G,B,D] [G,B,D] | G,, [G,B,D] [G,B,D] |  G,, [G,B,D] [G,B,D] | C,, [C,E,G,] [C,E,G,] |  C,, [C,E,G,] [C,E,G,] |  C,, [C,E,G,] [C,E,G,] |  C,, [C,E,G,] [C,E,G,] |
| C,, [C,E,G,] [C,E,G,] |  C,, [C,E,G,] [C,E,G,] |  C,, [C,E,G,] [C,E,G,] |  C,, [C,E,G,] [C,E,G,] | F,, [F,A,C] [F,A,C] | F,, [F,A,C] [F,A,C] |
| F,, [F,A,C] [F,A,C] | z3 | G,, [G,B,D] [G,B,D] | G,, [G,B,D] [G,B,D] | C,, [C,E,G,] [C,E,G,] |  C,, [C,E,G,] [C,E,G,] | 
| D,, [D,^F,A,] [D,^F,A,] | G,, [G,B,D] [G,B,D] | [C,E,G,] z [C,E,G,] || [K:G] z3 |  D,, [D,F,A,] [D,F,A,] |
| D,, [D,F,A,] [D,F,A,] | D,, [D,F,A,] [D,F,A,] | D,, [D,F,A,] [D,F,A,] | G,, [G,B,D] [G,B,D] | G,, [G,B,D] [G,B,D] | G,, [G,B,D] [G,B,D] |
| G,, [G,B,D] [G,B,D] | D,, [D,F,A,] [D,F,A,] | D,, [D,F,A,] [D,F,A,] | D,, [D,F,A,] [D,F,A,] | D,, [D,F,A,] [D,F,A,] | E,, [G,B,D] [G,B,D] |
| A,, [A,CE] [A,CE] | D,, [D,F,A,] [D,F,A,] | G,, [G,B,D] [G,B,D] | G,, [G,B,D] [G,B,D] | [C,E,G,] z [C,E,G,] | G,, [G,B,D] [G,B,D] |]
V:3 accordionTab
</textarea>
    
<textarea id="abcd" class="abc_textarea" spellcheck="false" cols="120" rows="10"  style="display: none;">
X:2020
%%barnumbers 1
%%papersize A4
%%pagenumbering
%%staffsep 20
%barsperstaff 4
T:Baile de Candieiro (club)
R:rancheira
Z:Flávio Vani
L:1/8
M:3/4
Q:130
K:F
V:1 clef=treble
| C4 |!segno! D4 |: E4 | F4 !dacoda! |1 G4 !dsalcoda!:|2 C4 | !coda!G4 |
%teste13 - workaround  || C4 | !segno! D4 | E4 |!dacoda! e4 | F4 | !dsalcoda! f4 |!coda! G4 | A4 !fine!|
%| C4 | !segno! D4 | E4 | e4 |1 F4 | !dsalfine! f4 |2 G4 | A4 !fine!|
%teste12 | C4 | !segno! D4 | E4 | e4 | F4 |1 !dsalfine! f4 |2 G4 | A4 !fine!|
%teste11 | C4 | !segno! D4 | E4 !dacoda!| e4 | F4 | f4 | G4 | A4 !dsalcoda!|
%teste10 | C4 | !segno! D4 | E4 !dacoda!| e4 | F4 | f4 !coda!| G4 | A4 !dsalcoda!|
%teste09 | C4 |:!segno! D4 | E4 :|: F4 !fine!| G4 :| A4 !dsalfine!|
%teste08 | C4 |:!segno! D4 | E4 :|: F4 | G4 :| A4 !dasegno!|
%teste07 | C4 |: D4 | E4 :|: F4 | G4 :| A4 !dacapo!|
%teste06 |: D4 | ^D4 |1 E4 :|2 F4 | G4 |1 ^G4 :|2 A4 | B4 |
%teste05 |: D4 | ^D4 | E4 :| F4 | G4 | ^G4 :| A4 | B4 |
%teste04 | C4 |: D4 |1 E4 :|2 F4 | G4 :| A4 |
%teste03 | C4 |: D4 | E4 :| F4 | G4 :| A4 |
%teste02 | C4 |: D4 | E4 :|: F4 | G4 :| A4 |
%teste01 | C4 |: D4 | E4 :| F4 |
</textarea>
    
    
<textarea id="abcc" class="abc_textarea" spellcheck="false" cols="120" rows="10"  style="display: none;">
X:1017
%%barnumbers 1
%%papersize A4
%%landscape
%%pagenumbering
%%staffsep 20
T:Tristeza do Jeca 
C:Angelino de Oliveira
Z:Flávio Vani
R:Baião
K:G
L:1/8
M:2/4
Q:60
% verificar bug de "=G" !== "G"
V:1 treble
%| ^G G- | G |
%| [^GD] [GD]- | [GD] |
| z [^G,D]-[G,D]/2-[G,/2D/2]  [=G,D]- | [G,D]/2 B/2 [A,D] z2 !dacoda! |
V:2 bass
| B,,3/2[G,/2B,/2D/2] G,,[G,B,D] | D,,3/2[D,/2F,/2A,/2] D,,[D,F,A,] |
V:3 accordionTab
</textarea>
   </div>
    <br/>
    <div id="outrosControles" style="display:inline-block; color: #FFFFFF; background-color: #000; padding: 2px;">
        <span id="spanNomeGaita">Acordeons: </span>
        <select id="selGaitas" ></select>
        <select id="selKey" ></select>
        <input type="submit" id="maisOitava" value="+ Oitava" onclick="javascript:doTranspose(12);" />
        <input type="submit" id="menosOitava" value="- Oitava" onclick="javascript:doTranspose(-12);" />
        <input type="button" id="printBtn" value="Print Preview" />
        <input type="submit" id="forceRefresh" value="Refresh" onclick="javascript:doForceRefresh();" />
        <input type="checkbox" id="chkAutoRefresh" />Auto refresh 
        <input type="checkbox" id="chkDebug" onclick="javascript:doCheckDebug();" />Debug
        <input type="button" id="showMapBtn" value="Show Map" />
        <input type="button" id="switch_source" value="ABC/SVG" />
        <input type="button" id="playBtn" value="Play" />
        <input type="button" id="pauseBtn" value="Pause" />
        <input type="button" id="stopBtn" value="Stop" />
        <label id="currentPlayTime" style="font-weight: bold; color: yellow; padding-left: 5px; padding-right: 3px;">00:00.00</label>
    </div>
    </div> <!-- editorDiv -->
    <div id="title" style="display:none; background: rgba(255,255,0,0.5); position: relative;color: #000; z-index: -1;padding: 5px 11px 5px;">Loading API...</div>
    
    <div id="warningsDiv"><hr></div>
    <div id="canvasDiv" class="printPreviewClass"> </div>
        
        <script type="text/javascript">
            
            window.addEventListener('load', loadAccordions, false);

            function loadAccordions() {
                
                MIDI.widget = new sketch.ui.Timer({size:180, cor1:'#ffffff', cor2:'#ffff88' });
                MIDI.widget.setFormat( 'Carregando...');
                MIDI.widget.setValue(1);

                DIATONIC.map.loadAccordionMaps(
                    [
                       'accordions/hohner.gc.accordion'
                      ,'accordions/hohner.cf.club.br.accordion'
                      ,'accordions/leticce.cf.ne.accordion'
                    ]
                    , function () { // call back after loading
                        FILEMANAGER.waitResources( { 
                            onProgress: function(event) {
                                if(event.success){
                                    MIDI.widget.setValue(0+Math.round(event.perc*.1));
                                    console.log('\nPercentual: '+ event.perc + '\nTimeouts: ' + event.timeouts + '\n' + event.success );
                                } else {
                                    MIDI.widget.setValue(0+Math.round(event.perc*.1));
                                    console.log('\nPercentual: '+ event.perc);
                                }
                            }
                            ,onLoad: loadMIDI 
                        });
                    } 
                );
            }
            
            function loadMIDI() {
                
                MIDI.widget.setValue(10);
                
                MIDI.loadPlugin({
                     soundfontUrl: "./soundfont/"
                    ,instruments: "accordion" // default
                    ,onprogress: function(event) {
                        MIDI.widget.setValue(10+Math.round(MIDI.getPercent(event)*.4));
                    }         
                    ,onprogress2: function( percent ) {
                        MIDI.widget.setValue(50+Math.round(percent*.5));
                    }        
                    ,callback: initApp
                });
            }
            
            
            
            function initApp() {
                
                console.log( 
                      '\nchromium: ' + ABCXJS.misc.isChromium() 
                    + '\nchrome: ' + ABCXJS.misc.isChrome() 
                    + '\nfirefox: ' + ABCXJS.misc.isFirefox()  
                    + '\nIE: ' + ABCXJS.misc.isIE() + '\n '
                );
                
                ypos = 0;
                lastYpos = 0;
                lastStaffGroup = null;
                debug = false;
                myEditor = {};

                printButton = document.getElementById("printBtn");
                playButton = document.getElementById("playBtn");
                pauseButton = document.getElementById("pauseBtn");
                stopButton = document.getElementById("stopBtn");
                showMapButton = document.getElementById("showMapBtn");
                switchSourceButton = document.getElementById("switch_source");
                cpt = document.getElementById("currentPlayTime");
                
                switchSourceButton.addEventListener("click", function() {
                    a = document.getElementById('abc');
                    s = document.getElementById('svg_source');
                    if( s.style.display === 'inline' ) {
                        s.style.display = 'none';
                        a.style.display = 'inline';
                    } else {
                        s.value = document.getElementById('canvasDiv').innerHTML;
                        s.style.display = 'inline';
                        a.style.display = 'none';
                    }
                }, false);
                
                player = new ABCXJS.midi.Player();
                
                
                playerCallBackOnPlay = function ( player ) {
                    cpt.innerHTML = player.getTime().cTime;
                };
                
                playerCallBackOnScroll = function ( player ) {
//                { // se possivel aplicar esta mesma lógica em playerCallBackOnScroll 
//                    var fixedTop = player.printer.staffgroups[0].top;
//                    var vp = this.studioCanvasDiv.clientHeight - fixedTop;
//                    var top = player.printer.staffgroups[player.currAbsElem.staffGroup].top;
//                    var bottom = top + player.printer.staffgroups[player.currAbsElem.staffGroup].height;
//
//                    if( bottom > vp+this.ypos || this.ypos > top-fixedTop ) {
//
//                        this.ypos = top;
//                        this.studioCanvasDiv.scrollTop = this.ypos;    
//                   }
//                }  
                
                    if( player.currAbsElem.staffGroup === lastStaffGroup )  return;
                    
                    lastStaffGroup = player.currAbsElem.staffGroup;
                    
                    var fixedTop = document.getElementById('editorDiv').clientHeight;
                    var wtop = document.getElementById('canvasDiv').offsetTop -
                               fixedTop;

                    var wh = window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight;                   

                    var vp = wh - fixedTop;
                        
                    var top = player.printer.staffgroups[player.currAbsElem.staffGroup].top;
                    var bottom = top + player.printer.staffgroups[player.currAbsElem.staffGroup].height;
                    
                    if( wtop+bottom > vp+window.ypos || window.ypos-wtop > top ) {
                        window.ypos = wtop + top;
                        window.scrollTo( 0, window.ypos );    
                    }
                };
                
                playerCallBackOnEnd = function (player) {
                    cpt.innerHTML = "00:00.00";
                    myEditor.printer.clearSelection();
                    var warns = player.getWarnings();
                    window.scrollTo( 0, 0 );
                    if( warns ) {
                        var txt = "";
                        warns.forEach(function(msg){ txt += msg + '<br>'; });
                        document.getElementById("warningsDiv").innerHTML = '<hr>'+txt;
                    }
                };
                
                editorCallbackOnChange = function ( editor ) {
                    editor.callback();
                };
                
                player.defineCallbackOnEnd(playerCallBackOnEnd);
                player.defineCallbackOnPlay(playerCallBackOnPlay);
                player.defineCallbackOnScroll(playerCallBackOnScroll);
 
                myEditor = new ABCXJS.Editor(
                    "abc", 
                    {
                         canvas_id: "canvasDiv"
                        ,abcText: "demo"
                        ,refreshController_id: "chkAutoRefresh"
                        ,keySelector_id: "selKey"
                        ,accordionSelector_id: "selGaitas"
                        ,accordionNameSpan: "spanNomeGaita"
                        ,generate_midi: true
                        ,warnings_id: "warningsDiv"
                        ,generate_warnings: true
                        ,generate_tablature: 'accordion'
                        ,accordion_options: {
                                 //id: 'GAITA_LETICCE_CF_NE'
                                 id: 'GAITA_HOHNER_GC'
                               //  id: 'GAITA_HOHNER_CLUB_IIIM_BR'
                                ,keyboardDiv_id:"keyboardDiv"
                                ,accordionMaps: DIATONIC.map.accordionMaps
                                ,render_keyboard_opts:{transpose:false, mirror: true, scale:1, draggable:false, show:true, label:false}}
                        ,midi_options: {program: 21, qpm: 150, type: "qt"}
                        ,render_options: {}
                        ,onchange: editorCallbackOnChange
                        ,gui: false
                    } );
                    
                //myEditor.accordion.printKeyboard('keyboardDiv' /*, {fillColor:'yellow', openColor:'navy', closeColor:'purple', backgroundColor:'gray' }*/ );
                myEditor.accordion.printKeyboard('keyboardDiv' );
                    
                printButton.addEventListener("click", function(e) {
                    e.preventDefault();

                    var kd = document.getElementById("keyboardDiv").style.display;

                    document.getElementById("keyboardDiv").style.display = 'none';
                    document.getElementById("editorDiv").style.display = "none";
                    document.getElementById("warningsDiv").style.display = "none";
                    document.body.style.paddingTop = '0px';
                    
                    window.print();
                    
                    document.body.style.paddingTop = '190px';
                    document.getElementById("warningsDiv").style.display = "inline";
                    document.getElementById("editorDiv").style.display = "inline";
                    document.getElementById("keyboardDiv").style.display = kd;
                }, false);
                
                playButton.addEventListener("click", function(e) {
                    e.preventDefault();
                    myEditor.accordion.clearKeyboard();
                    player.startPlay( myEditor.tunes[0].midi );
                    //player.startDidacticPlay(myEditor.tunes[0].midi, 'note');
                    //player.startDidacticPlay(myEditor.tunes[0].midi, 'measure', 2 );
                    //player.startDidacticPlay(myEditor.tunes[0].midi, 'repeat', 1, 4);
                }, false);
                pauseButton.addEventListener("click", function(e) {
                    e.preventDefault();
                    player.pausePlay();
                }, false);
                stopButton.addEventListener("click", function(e) {
                    e.preventDefault();
                    myEditor.accordion.clearKeyboard();
                    player.stopPlay();
                }, false);
                
                showMapButton.addEventListener("click", function(e) {
                    e.preventDefault();
                    myEditor.accordion.render_keyboard_opts.show = !myEditor.accordion.render_keyboard_opts.show;
                    this.value = myEditor.accordion.render_keyboard_opts.show? 'Hide Map':'Show Map';
                    myEditor.accordion.printKeyboard('keyboardDiv');
                }, false);
                
            }

            function doTranspose(value) {
                var doc = document.documentElement;
                window.lastYpos = (window.pageYOffset || doc.scrollTop)  - (doc.clientTop || 0);                
                myEditor.fireChanged(value, "force");
            };

            function doForceRefresh() {
                var doc = document.documentElement;
                window.lastYpos = (window.pageYOffset || doc.scrollTop)  - (doc.clientTop || 0);                
                myEditor.fireChanged(0, "force");
            };

            function doCheckDebug() {
                debug = document.getElementById("chkDebug").checked;
                var doc = document.documentElement;
                window.lastYpos = (window.pageYOffset || doc.scrollTop)  - (doc.clientTop || 0);                
                //myEditor.fireChanged(0, "force");
            };

        </script>        

        <div id="keyboardDiv"></div> 
    </body>
    
</html>
