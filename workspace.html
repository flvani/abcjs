<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" lang="en">
    <head>
    <link href="workspace.css" rel="stylesheet"></link>
            <!-- 
          MAIN DATA STRUCTURES
        
            Tune
              midi {}
              lines[]
                staffs[]
                   voices[]

            Printer
              layouter  Layout {}
              staffgroups[] Staffgroup {}

            Layout 
              Staffgroup {}
                 voices[]
                   beams[]
                   children[]
                   otherchildren[]
                   stave {}

            stave {}
               y
               top
               bottom
               highest
               lowest
        
           DONE:
             Verificar o transporte de keys com modos min e maj
             Verificar os limites máximo e mínimos para transporte de keys
             Ignorar Accents na transposição
             Tablatura: gerar mesmo sem o baixo
             Layout:    Revisar a impressão dos elementos ending, accents e lyrics
             Layout:    Revisar a de linhas de texto, quando há mais de uma linha
             Tablatura: imprimir os de pausas adequadamente no baixo
             Tablatura: parse
                tratar numeros hexa
                tratar a adicao de pausas - continuacao
                tratar acordes
                tratar startChar e endChar
                registar o parse da tablatura
                gerar a linha durante a inferencia
                imprimir baseado na linha existente
                melhorar a relação open/close do fole na melodia
                revisar a impressão de múltiplas notas na mesma coluna
        
           TODO:
             Tablatura: 
                tratar adequadamente os acordes (de baixo)      
                promover a inversão do fole se a posição do botao for melhor
        
        -->
	<title>Draw The Dots: Tune Editor</title>
        <meta http-equiv="content-type" content="text/html; charset=UTF-8"></meta>
    </head>
    <body class="mapa">

	<script type="text/javascript" src="proto_noconflict.js" ></script>

        <script type="text/javascript" src="MIDI.js/MIDI_2.04-min.js"></script>
        
        <script type="text/javascript" src="jquery/jquery-1.11.1.min.js" ></script>
        <!--
        <script type="text/javascript" src="raphael/raphael-hevans66-min.js" ></script>
        <script type="text/javascript" src="raphael/raphael_2.1.3.js" ></script>
        -->
        <script type="text/javascript" src="raphael/raphael_2.1.4-min.js" ></script>
	        
        <script type="text/javascript" src="file/filemanager.js" ></script>

        <script type="text/javascript" src="api/abc_tunebook.js" ></script>
        
        <script type="text/javascript" src="data/abc_tune.js" ></script>
        
	<script type="text/javascript" src="parse/abc_common.js" ></script>
        <script type="text/javascript" src="parse/abc_parse_header.js" ></script>
	<script type="text/javascript" src="parse/abc_tokenizer.js" ></script>
	<script type="text/javascript" src="parse/abc_parse_key_voice.js" ></script>
	<script type="text/javascript" src="parse/abc_parse_directive.js" ></script>
        <script type="text/javascript" src="parse/abc_parse.js" ></script>
        <script type="text/javascript" src="parse/abc_transposer.js" ></script>

        <script type="text/javascript" src="midi/midi_common.js" ></script>
        <script type="text/javascript" src="midi/midi_parser.js" ></script>
        <script type="text/javascript" src="midi/midi_player.js" ></script>

        <script type="text/javascript" src="write/sprintf.js" ></script>
        <script type="text/javascript" src="write/abc_glyphs.js" ></script>
        <script type="text/javascript" src="write/abc_graphelements.js" ></script>
        <script type="text/javascript" src="write/abc_layout.js" ></script>
        <script type="text/javascript" src="write/abc_write.js" ></script>

        <!-- diatonic accordion map -->
        <script type="text/javascript" src="diatonic/diatonic_common.js"></script>
        <script type="text/javascript" src="diatonic/diatonic_accordion_map.js"></script>
        <script type="text/javascript" src="diatonic/diatonic_keyboard.js"></script>
        <script type="text/javascript" src="diatonic/diatonic_button.js"></script>
        
        <!-- support for diatonic accordion tablature -->
        <script type="text/javascript" src="tablature/tablature_accordion.js"></script>
        <script type="text/javascript" src="tablature/tablature_accordion_infer.js"></script>
        <script type="text/javascript" src="tablature/tablature_accordion_parse.js"></script>
        <script type="text/javascript" src="tablature/tablature_accordion_layout.js"></script>
        
 	<script type="text/javascript" src="edit/abc_editor.js" ></script>

    
<div id="editorDiv" style="position: fixed; top:0; display:inline-block; background-color: gray; width:100%; z-index: 100;"> 
<div id="editControl" style="display:inline-block;"> 

<textarea id="abc" cols="120" rows="10" >
X:1023
%%barnumbers 0
%%papersize A4
%%pagenumbering
T:Paraíba Masculina
C:Luiz Gonzaga & Humberto Teixeira
Z:Flávio Vani
N:Mapa para Acordeons Diatônicos powered by ABCXJS.
F:https://www.youtube-nocookie.com/embed/69rv13vRK98
M:2/4
L:1/16
Q:100
K:G
V:1 treble
|: [Bdg]8 | [GBd]8 | [GBe]8 | [DGB]8 | [Ed]6 [DG]2 | [EA]2[EG] 2 [EC]2[EG]2  |1 [B,DG]8 | [DFA]8 :|
|2 [B,DG]4 z "G" D2G | B2d2 d2d2 | d3B B2B2 | A2G2 F2=F2 | "Am" E4 z C2E | A2c2 c2c2 |
w:* * Quando * a~la-ma vi-rou pe-dra e man-da-ca-ru se-cou, quando * o ri-ba-ção
| c3A "D7" A2G2 | F2F2 E2E2 | "G" D4 z B2d | A2G2 B2d2 | "G7" A3G- GA2G | A2G2 A2B2 |
w:de se-de  ba-teu asa e vo-ou, foi aí que eu vim m'em-bo-ra, car-re-gan-do a mi-nha 
| "C" c4 z A2B | "Cm" cA2B cB2A  | "G" BB2G E2D2 | g2bg "D7" e2ge | "C" d2ed B2 z2 |
w: dor. Hoje eu mando * um abraço * pra ti, pe-que-ni-na!  
|: "G" D2D2 G2G2 | B2B2 "Am" A2A2 | c2c2 "D7" B2B2 | A2A2 "G" G4 :|
w: Pa-ra-í-ba, mas-cu-li-na, mu-lher ma-cho, sim, se-nhor!
| "G" B3G- GD2F | E3D- DG2F | E2D2 G2E2 | "Am" F8 |
w:Ei-tá, * pau pe-rei-ra, * Qu'em Prin-ce-sa já ron-cou!
| c3A- AF2A | "D7" G3F- FA2A | F2F2 E2E2 | "G" D8 |
w:Ei-tá, * pa-ra-í-ba, mu- * lher ma-cho, sim, se-nhor!
| B3G- GD2F | E3D- DG2A | B3B1 A3G1 | "C"  E4 z A2B |
w:Ei-tá, * pau pe-rei-ra, * meu bo-do-que não que-brou. Hoje eu 
| "Cm" cA2B cB2A  | "G" BB2G E2D2 | g2bg "D7" e2ge | "C" d2ed B2 z2 |
w: mando * Um abraço * pra ti, pe-que-ni-na! 
|: "G" D2D2 G2G2 | B2B2 "Am" A2A2 | c2c2 "D7" B2B2 | A2A2 "G" G4 :|
w: Pa-ra-í-ba, mas-cu-li-na, mu-lher ma-cho, sim, se-nhor!
|: "G" [Bdg]8 | [GBd]8 | [GBe]8 | [DGB]8 | "C7" [Ed]6 [DG]2 | [EA]2[EG] 2 [EC]2[EG]2  |1  "G" [B,DG]8 | [DFA]8 :|2  [B,DG]8- | [B,DG]4 z4 |
w: Ei-tá! Ei-tá! Mu-ié macho, * sim se-nhor! * nhor!
V:2 bass
|:z8|z8|z8|z8|z8|z8|1 z8|z8:|
|2 z4 z4 | G,,3[G,B,D] G,,2[G,B,D]2 | G,,2[G,B,D] 2 G,,2[G,B,D]2 |G,,3[G,B,D]  G,,2[G,B,D]2 | A,,2[A,CE] 2 A,,3[A,CE] | A,,2[A,CE] 2 A,,2[A,CE]2 |
|A,,3[A,CE] D,,2[D,F,A,]2 | D,,2[D,F,A,] 2 D,,2[D,F,A,] 2  | G,,2[G,B,D] 2  G,,3[G,B,D] |G,,2[G,B,D] 2  G,,2[G,B,D]2 | G,,3[G,B,D]   G,,2[G,B,D]2 | G,,2[G,B,D] 2  G,,2[G,B,D]2 |
| C,,2[C,E,G,] 2 A,,3[C,E,G,]| A,,3[C,E,G,]  C,,2[C,E,G,] z| G,,3[G,B,D] G,,2[G,B,D]2| G,,2[G,B,D] 2 D,,2[D,F,A,] 2 | C,,2[C,E,G,] 2 C,,2[C,E,G,] 2 |
|: G,,3[G,B,D]  G,,2[G,B,D]2|G,,2[G,B,D] 2 A,,3[A,CE]  | A,,2[A,CE] 2 D,,3[D,F,A,] | D,,2[D,F,A,] 2 G,,3[G,B,D] :|
| G,,3[G,B,D]  G,,2[G,B,D]2|G,,2[G,B,D] 2 G,,2[G,B,D] 2|G,,3[G,B,D] G,,2[G,B,D] 2| A,,2[A,CE] 2 A,,2[A,CE]2 |
|A,,3[A,CE] A,,2[A,CE]2 | D,,3[D,F,A,] D,,2[D,F,A,] 2|D,,2[D,F,A,] 2 D,,2[D,F,A,] 2| G,,2[G,B,D] 2 G,,2[G,B,D] 2|
|G,,2[G,B,D] 2 G,,2[G,B,D] 2|G,,2[G,B,D] 2 G,,2[G,B,D] 2|G,,2[G,B,D] 2 G,,2[G,B,D] 2| C,,2[C,E,G,] 2 A,,3[C,E,G,]|
| A,,3[C,E,G,]  C,,2[C,E,G,] z| G,,3[G,B,D] G,,2[G,B,D]2| G,,2[G,B,D] 2 D,,2[D,F,A,] 2 | C,,2[C,E,G,] 2 C,,2[C,E,G,] 2 |
|: G,,3[G,B,D]  G,,2[G,B,D]2|G,,2[G,B,D] 2 A,,3[A,CE]  | A,,2[A,CE] 2 D,,3[D,F,A,] | D,,2[D,F,A,] 2 G,,3[G,B,D] :|
|: G,,3[G,B,D] G,,2[G,B,D]2| G,,2[G,B,D] 2 G,,2[G,B,D]2 | G,,3[G,B,D] G,,2[G,B,D]2 | G,,2[G,B,D] 2 G,,2[G,B,D]2 | C,,3[C,E,G,] C,,2[C,E,G,] 2 | A,,2[C,E,G,] 2 C,,2[C,E,G,] 2 |1 G,,3[G,B,D] G,,2[G,B,D]2| G,,2[G,B,D] 2 G,,2[G,B,D]2 :|2 G,,2[G,B,D] 2 G,,4- | G,,4 z4 |
V:3 accordionTab
|: z+[788']8 | z-[5'6'7']8 | z+[677']8 | z-[3'5'6']8 | z+[4'8]6 z+[55']2 | z-[57]2 z-[55']2 z-[45]2 z-[55']2 |1 z+[455']8 | z-[3'67]8 :|
|2 z+[455']4 z+z z+52 z+5' | G-6'2 >-7' g-> G-7'2 g-7'2 | G+82 g+> >+7 G+72 g+72 | G-72 >-5' g-> G-62 g-4'2 | A-52 a->2 A-z >-42 a-5 | A-72 a-82 A-82 a-82 |
| A-83 a-7 D-72 d-5'2 | D-62 d-62 D-52 d-52 | G+52 g+>2 G+z >+72 g+8 | G-72 g-5'2 G-6'2 g-7'2 | G-73 g-5' G-> >-7 g-> >-5' | G-72 g-5'2 G-72 g-6'2 |
| C+6'2 c+>2 A-z >-72 c+7 | A-8 >-72 c+7 C+6' >+7 c+> z-7 | G-6' >-6'2 g-5' G-52 g-3'2 | G+8'2 g+a >+9 D-92 d-9' >-9 | C+82 c+7' >+8 C+72 c+z2 |
|: G+52 >+5 g+> G+5'2 g+5'2 | G-6'2 g-6'2 A-72 >-7 a-> | A-82 a-82 D-6'2 >-6' d-> | D-72 d-72 G+63 g+> :|
| G+73 g+6 G+> >+5 g+> >-6 | G-52 g-> >-3' G-> >-5' g-> >-6 | G+4'2 >+5 g+> G+5'2 g+4'2 | A-62 a->2 A->2 a->2 |
| A-83 a-7 A-> >-6 a-> >-7 | D-5'3 d-6 D-> >-7 d-> >-7 | D-62 d-62 D-52 d-52 | G+52 g+>2 G+>2 g+>2 |
| G+72 g+> >+6 G+> >+5 g+> >-6 | G-52 g-> >-3' G-> >-5' g-> >-7 | G+72 g+> >+7 G-72 g-> >-5' | C+4'2 c+>2 A-z >-72 c+7 |
| A-8 >-72 c+7 C+6' >+7 c+> z-7 | G-6' >-6'2 g-5' G-52 g-3'2 | G+8'2 g+a >+9 D-92 d-9' >-9 | C+82 c+7' >+8 C+72 c+z2 |
|: G+52 >+5 g+> G+5'2 g+5'2 | G-6'2 g-6'2 A-72 >-7 a-> | A-82 a-82 D-6'2 >-6' d-> | D-72 d-72 G+63 g+> :|
|: G+[788']3 g+[>>>] G+[>>>]2 g+[>>>]2 | G-[5'6'7']2 g-[>>>]2 G-[>>>]2 g-[>>>]2 | G+[677']3 g+[>>>] G+[>>>]2 g+[>>>]2 | G-[3'5'6']2 g-[>>>]2 G-[>>>]2 g-[>>>]2 | C+[4'8]3 c+[>>] C+[>>]2 c+[55']2 | A-[57]2 c+[4'5']2 C+[3'4']2 c+[4'5']2 |1 G+[455']3 g+[>>>] G+[>>>]2 g+[>>>]2 | G-[3'67]2 g-[>>>]2 G-[>>>]2 g-[>>>]2 :|2 G+[455']2 g+[>>>]2 G+[>>>]4 | >+[>>>]4 z-z4 |
</textarea>
    
<textarea id="abcx" cols="120" rows="10" style="display: none;" >
% TODO: este trecho do rincao expoe um problema de continuidade da nota "inTie" na transição de uma linh para outra
X:1
%%papersize A4
%%barnumbers 0
%%score (0 1) 2 3
T:Rincão dos Maciel
C:Reduzino Malaquias
L:1/16
Q:78
M:2/4
K:G
V:0 treble stem=up
V:1 treble
V:2 bass
[V:0]|:x8|d8-| %5
[V:1]|: [DB]2[Ec]2[DB]2d2 | A2C2A,2C2 |
[V:2]|: G,,3[G,B,D] G,,2[G,B,D]2 | D,,3[D,F,A,] D,,2[D,F,A,]2 |
[V:0]|-d8| x8 :| %6
[V:1]|D2C2B,2A,2 | B,2[B,DG]2 z B,CD :|
[V:2]| D,,3[D,F,A,] D,,2[D,F,A,]2 | G,,3[G,B,D] G,,2[G,B,D]2 :|
V:3 
K:none accordionTab

X:1008
%%barnumbers 0
%%papersize A4
T:Prenda Minha
C:Tradicional
M:C
L:1/8
Q:20
K:G
V:1 clef=treble
V:2 clef=bass
[V:1]| (3DGB  | d2G2G2 (3DGc               | B2A2A2 d3/2e1/2             | d2 c2 B2 A2                   |              B4 z2  (3DGB |
[V:2]| z2     | G,,2 [G,B,D]2 [G,B,D]2 z2  | D,,2 [D,F,A,]2 [D,F,A,]2 z2 | D,,2 [D,F,A,]2 D,,2 [D,F,A,]2 | z2 G,,2 [G,B,D]2 [G,B,D]2 |
Z:Flavio Vani
V:3 accordionTab

</textarea>
   </div>
    <br/>
    <div id="outrosControles" style="display:inline-block; color: #FFFFFF; background-color: #000; padding: 2px;">
        <span id="spanNomeGaita">Acordeons: </span>
        <select id="selGaitas" ></select>
        <select id="selKey" ></select>
        <input type="submit" id="maisOitava" value="+ Oitava" onclick="javascript:doTranspose(12);" />
        <input type="submit" id="menosOitava" value="- Oitava" onclick="javascript:doTranspose(-12);" />
        <input type="button" id="printBtn" value="Print Preview" />
        <input type="submit" id="forceRefresh" value="Refresh" onclick="javascript:doForceRefresh();" />
        <input type="checkbox" id="chkAutoRefresh" />Auto refresh 
        <input type="checkbox" id="chkDebug" onclick="javascript:doCheckDebug();" />Debug
        <input type="button" id="showMapBtn" value="Show Map" />
        <input type="button" id="playBtn" value="Play" />
        <input type="button" id="pauseBtn" value="Pause" />
        <input type="button" id="stopBtn" value="Stop" />
        <label id="currentPlayTime" style="font-weight: bold; color: yellow; padding-left: 5px; padding-right: 3px;">00:00.00</label>
    </div>
    </div> <!-- editorDiv -->
    <div id="warningsDiv"><hr></div>
    <div id="canvasDiv" class="printPreviewClass"> </div>
        
        <script type="text/javascript">
            
            window.addEventListener('load', loadMIDI, false);

            function loadMIDI() {
                MIDI.loader = new widgets.Loader();
                
                MIDI.loadPlugin({
                    soundfontUrl: "./soundfont/"
                   ,instruments: "accordion"
                   ,callback: postLoadMIDI
                });
            }
            
            function postLoadMIDI() {
                MIDI.loader.stop();
                MIDI.programChange(0, 21); // canais para accordeon
                MIDI.programChange(1, 21); // 
                MIDI.programChange(2, 21); // 
                MIDI.programChange(3, 21); // 
                MIDI.programChange(4, 21); // 
                MIDI.programChange(5, 21); // 
                
                DIATONIC.map.loadAccordionMaps(
                    [
                       'accordions/hohner.gc.accordion'
                      ,'accordions/hohner.cf.club.br.accordion'
                      ,'accordions/leticce.cf.ne.accordion'
                    ]
                    ,initApp // call back after loading
                );
            }
            
            function initApp() {

                ypos = 0;
                lastYpos = 0;
                debug = false;
                myEditor = {};

                printButton = document.getElementById("printBtn");
                playButton = document.getElementById("playBtn");
                pauseButton = document.getElementById("pauseBtn");
                stopButton = document.getElementById("stopBtn");
                showMapButton = document.getElementById("showMapBtn");
                cpt = document.getElementById("currentPlayTime");
                
                player = new ABCXJS.midi.Player();
                
                
                playerCallBackOnPlay = function ( player ) {
                    cpt.innerHTML = player.getTime().cTime;;
                };
                
                playerCallBackOnScroll = function ( player ) {
                    if( player.currChannel > 0 ) return;
                    if( player.currAbsElem.y !== window.ypos ) {
                        window.ypos = player.currAbsElem.y;
                        window.scrollTo( 0, window.ypos - 40);    
                    }
                };
                
                playerCallBackOnEnd = function (player) {
                    cpt.innerHTML = "00:00.00";
                    myEditor.printer.clearSelection();
                    var warns = player.getWarnings();
                    window.scrollTo( 0, 0 );
                    if( warns ) {
                        var txt = "";
                        warns.forEach(function(msg){ txt += msg + '<br>'; });
                        document.getElementById("warningsDiv").innerHTML = '<hr>'+txt;
                    }
                };
                
                editorCallbackOnChange = function ( editor ) {
                    editor.callback();
                };
                
                player.defineCallbackOnEnd(playerCallBackOnEnd);
                player.defineCallbackOnPlay(playerCallBackOnPlay);
                player.defineCallbackOnScroll(playerCallBackOnScroll);
 
                myEditor = new ABCXJS.Editor(
                    "abc", 
                    {
                         canvas_id: "canvasDiv"
                        ,abcText: "demo"
                        ,refreshController_id: "chkAutoRefresh"
                        ,keySelector_id: "selKey"
                        ,accordionSelector_id: "selGaitas"
                        ,accordionNameSpan: "spanNomeGaita"
                        ,generate_midi: true
                        ,warnings_id: "warningsDiv"
                        ,generate_warnings: true
                        ,generate_tablature: 'accordion'
                        ,accordion_options: {
                                 //id: 'GAITA_LETICCE_CF_NE'
                                 id: 'GAITA_HOHNER_GC'
                                ,keyboardDiv_id:"keyboardDiv"
                                ,accordionMaps: DIATONIC.map.accordionMaps
                                ,render_keyboard_opts:{transpose:false, mirror: false, scale:0.8, draggable:true, show:false, label:false}}
                        ,midi_options: {program: 21, qpm: 150, type: "qt"}
                        ,render_options: {}
                        ,onchange: editorCallbackOnChange
                        ,gui: false
                    } );

                printButton.addEventListener("click", function() {
                    var style = document.createElement('style');
                    var orientation = myEditor.tunes[0].formatting.landscape?'landscape':'portrait';
                    document.head.appendChild(style);
                    style.innerHTML = '@page {margin: 1cm; size: ' + orientation + '}';
                    
                    document.getElementById("editorDiv").style.display = "none";
                    document.getElementById("warningsDiv").style.display = "none";
                    document.body.style.paddingTop = '0px';
                    window.print();
                    document.body.style.paddingTop = '190px';
                    document.getElementById("warningsDiv").style.display = "inline";
                    document.getElementById("editorDiv").style.display = "inline";
                }, false);
                
                playButton.addEventListener("click", function() {
                    player.startPlay( myEditor.tunes[0].midi );
                    player.startDidacticPlay(myEditor.tunes[0].midi, 'note');
                    //player.startDidacticPlay(myEditor.tunes[0].midi, 'measure');
                }, false);
                pauseButton.addEventListener("click", function() {
                    player.pausePlay();
                }, false);
                stopButton.addEventListener("click", function() {
                    player.stopPlay();
                }, false);
                
                showMapButton.addEventListener("click", function() {
                    myEditor.accordion.render_keyboard_opts.show = !myEditor.accordion.render_keyboard_opts.show;
                    this.value = myEditor.accordion.render_keyboard_opts.show? 'Hide Map':'Show Map';
                    myEditor.accordion.printKeyboard('keyboardDiv');
                }, false);
            }

            function doTranspose(value) {
                var doc = document.documentElement;
                window.lastYpos = (window.pageYOffset || doc.scrollTop)  - (doc.clientTop || 0);                
                myEditor.fireChanged(value, "force");
            };

            function doForceRefresh() {
                var doc = document.documentElement;
                window.lastYpos = (window.pageYOffset || doc.scrollTop)  - (doc.clientTop || 0);                
                myEditor.fireChanged(0, "force");
            };

            function doCheckDebug() {
                debug = document.getElementById("chkDebug").checked;
                var doc = document.documentElement;
                window.lastYpos = (window.pageYOffset || doc.scrollTop)  - (doc.clientTop || 0);                
                myEditor.fireChanged(0, "force");
            };

        </script>        

        <div id="keyboardDiv" style="position:fixed; top:50px; left:80%;"></div> 
    </body>
    
</html>
